import { RenderAppBreadcrumb } from "@/components/app-breadcrumb";
import WebAppPentestConfigModule from "./components/WebAppPentestConfigModule";
import { fetchData } from "@/utils/api";
import { getLoggedInUserProfile } from "@/ikon/utils/api/loginService";
import { PenTestWithoutScanDefault, PenTestWithoutScanModified } from "@/app/pen-test/web-app-pen-test/components/type";

async function fetchLoggedInUserPentestData() {
    const userId = (await getLoggedInUserProfile()).USER_ID;

    console.log("user id ---------")
    console.log(userId);


    const fetchedData = await fetchData('penetration_testing_history', 'id', [{ column: 'type', value: 'web_app' }], null,
        "pentestid, data->'basicDetails' as basicdetails, userid, lastscanon");

    return fetchedData;
}

export default async function WebAppPentestConfig() {

    const loggedInUserPentestData: PenTestWithoutScanDefault[] = await fetchLoggedInUserPentestData() ? (await fetchLoggedInUserPentestData()).data : [];
    const loggedInUserPentestDataFormatted: PenTestWithoutScanModified[] = loggedInUserPentestData.map((eachPenTestData: PenTestWithoutScanDefault) => {
        return {
            userId: eachPenTestData.userid,
            pentestId: eachPenTestData.pentestid,
            pentestType: eachPenTestData.type,
            basicDetails: { ...eachPenTestData.basicdetails },
            lastUpdated: eachPenTestData.lastscanon,
        }
    });
    console.log("Pentest Data With New Func: ", loggedInUserPentestDataFormatted);

    return (
        <>
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 0,
                    title: "Configuration",
                }}
            />
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 1,
                    title: "PenTest Configuration",
                    href: "/configuration/pentest-configs",
                }}
            />
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 2,
                    title: "Web Application PenTest Configuration",
                    href: "/configuration/pentest-configs/web-app-pentest-config",
                }}
            />

            <div className="flex-1">
                <WebAppPentestConfigModule pentestData={loggedInUserPentestDataFormatted} />
            </div>
        </>
    )
}