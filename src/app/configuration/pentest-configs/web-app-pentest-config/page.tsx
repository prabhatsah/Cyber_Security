import { RenderAppBreadcrumb } from "@/components/app-breadcrumb";
import WebAppPentestConfigModule from "./components/WebAppPentestConfigModule";
import { fetchData } from "@/utils/api";
import { getLoggedInUserProfile } from "@/ikon/utils/api/loginService";
import { PenTestWithoutScanDefault, PenTestWithoutScanModified } from "@/app/pen-test/web-app-pen-test/components/type";
import { secureGaurdService } from "@/utils/secureGaurdService";

async function fetchLoggedInUserPentestData() {
    const userId = (await getLoggedInUserProfile()).USER_ID;

    console.log("user id ---------")
    console.log(userId);

    const currentRole = (await secureGaurdService.userDetails.getUserRolesForthisSoftware())[0].ROLE_NAME;
    const currentAccountId = await secureGaurdService.userDetails.getAccountId()

    let fetchedData = []
    if (currentRole == "Pentest Admin")
        fetchedData = await fetchData("pentest_data", "last_scan_on", [{ table: "user_membership", column: "generatedby", value: currentAccountId }], null, "pentest_data.pentestid , pentest_data.data->'basicDetails' as basicdetails,pentest_data.last_scan_on");
    else
        fetchedData = await fetchData("pentest_data", "last_scan_on", [{ table: "user_membership", column: "generatedby", value: currentAccountId }, { table: "user_membership", column: "userid", value: userId }], null, "pentest_data.pentestid");

    return fetchedData;
}

export default async function WebAppPentestConfig() {

    const loggedInUserPentestData: PenTestWithoutScanDefault[] = await fetchLoggedInUserPentestData() ? (await fetchLoggedInUserPentestData()).data : [];
    // console.log(loggedInUserPentestData);
    const loggedInUserPentestDataFormatted: PenTestWithoutScanModified[] = loggedInUserPentestData.map((eachPenTestData: PenTestWithoutScanDefault) => {
        return {
            userId: eachPenTestData.userid,
            // groupId: eachPenTestData.groupid,
            pentestId: eachPenTestData.pentestid,
            pentestType: eachPenTestData.type,
            basicDetails: { ...eachPenTestData.basicdetails },
            lastUpdated: eachPenTestData.lastscanon,
        }
    });
    console.log("Pentest Data With New Func: ", loggedInUserPentestDataFormatted);

    return (
        <>
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 0,
                    title: "Configuration",
                }}
            />
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 1,
                    title: "PenTest Configuration",
                    href: "/configuration/pentest-configs",
                }}
            />
            <RenderAppBreadcrumb
                breadcrumb={{
                    level: 2,
                    title: "Web Application PenTest Configuration",
                    href: "/configuration/pentest-configs/web-app-pentest-config",
                }}
            />

            <div className="flex-1">
                <WebAppPentestConfigModule pentestData={loggedInUserPentestDataFormatted} />
            </div>
        </>
    )
}