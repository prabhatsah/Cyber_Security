"use client";

import { useEffect } from "react";
import { usePentestContext } from "./PentestContext";
import GlobalLoader from "@/components/GlobalLoader";

export default function PentestProgressBar({ pentestIdName }: { pentestIdName: string }) {
    const [pentestId, pentestName] = pentestIdName.split("_");
    const { pentestData, loading, error, setPentestId } = usePentestContext();

    useEffect(() => {
        if (typeof pentestId === 'string') {
            setPentestId(pentestId);
        }
    }, [pentestId]);

    if (error) return <div>{error}</div>;
    if (!pentestData && !loading) return <div></div>;
    if (loading || !pentestData) return <GlobalLoader />;

    let progress = (2 / 6) * 100;
    if (pentestData.aiAnalysis && pentestData.aiAnalysis !== null) {
        progress = 100
    }
    if (pentestData.postExploitation && pentestData.postExploitation !== null) {
        progress = (5 / 6) * 100;
    }
    if (pentestData.exploitation && pentestData.exploitation !== null) {
        progress = (4 / 6) * 100;
    }
    if (pentestData.vulnerabilityScanning && pentestData.vulnerabilityScanning !== null) {
        progress = (5 / 6) * 100;
    }

    progress = Math.round(progress);

    return (
        <>
            <div className="flex items-center gap-2">
                <div className="w-40 bg-gray-200 rounded-full h-2.5">
                    <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                </div>
                <div className="text-xs text-widget-mainDesc mt-1">{progress}%</div>
            </div>
        </>
    );
}