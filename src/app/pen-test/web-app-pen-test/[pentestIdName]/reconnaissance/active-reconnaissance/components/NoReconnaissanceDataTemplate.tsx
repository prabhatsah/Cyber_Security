"use client";

import { Button } from "@/components/Button";
import { ScanLine } from "lucide-react";
import NoScanConfiguredTemplate from "../../../components/NoScanConfiguredTemplate";
import { amassScanning } from "./apis/amass/amassScanning";
import { useEffect, useState } from "react";
import { updatePentestData } from "@/app/pen-test/components/apis/configurePentestDataHandler";
import { useRouter } from "next/navigation";
import { PenTestModified } from "@/app/pen-test/web-app-pen-test/components/type";
import { useScanNotification } from "@/contexts/ScanNotificationContext";
import socket from "@/utils/web-socket";

export default function NoReconnaissanceDataTemplate({ pentestId, pentestData }: { pentestId: string; pentestData: PenTestModified }) {
    const webApp = pentestData.basicDetails.target;
    const router = useRouter();
    // const [amassScanData, setAmassScanData] = useState(null);
    const { setScanNotificationData } = useScanNotification();

    const updateDataAndRefresh = async (amassScanData: any) => {
        if (amassScanData) {
            // const updatedColumnData = {
            //     activeReconnaissance: {
            //         amassData: amassScanData,
            //     },
            // };

            const updatedDataObj = {
                basicDetails: { ...pentestData.basicDetails },
                scandata: {
                    ...pentestData.scanData,
                    amass: amassScanData
                }
            }

            const pentestDataUpdateResult = await updatePentestData("data", updatedDataObj, pentestId);

            if (pentestDataUpdateResult?.success) { // Optional: check if the update was successful
                router.refresh(); // Refresh the route after updating
            }
        }
    };
    const { initiateScan, isScanning } = amassScanning(webApp, pentestId);
    const [shouldConnectSocket, setShouldConnectSocket] = useState(false);

    // if (amassScanData) {
    //     const updatedColumnData = {
    //         "activeReconnaissance": {
    //             "amassData": amassScanData
    //         }
    //     }

    //     const pentestDataUpdateResult = await updatePentestData("reconnaissance", updatedColumnData, pentestId);
    // }

    // useEffect(() => {

    // }, [amassScanData]);

    useEffect(() => {
        if (!shouldConnectSocket) return;

        socket.connect();

        const handleScanComplete = (data: any) => {
            console.log('Scan completed:', data);
        };

        socket.on('scan_complete', handleScanComplete);

        return () => {
            socket.off('scan_complete', handleScanComplete);
            socket.disconnect();
        };
    }, [shouldConnectSocket]); // depends on the state

    async function handleInitiateActiveRecon() {
        const scanResult = await initiateScan();
        setScanNotificationData((prev) => {
            return [...prev, scanResult];
        });
        setShouldConnectSocket(true);
    }

    return (
        <>
            <div className="flex flex-col gap-4">
                <div className="flex items-center justify-end">
                    {isScanning ? (
                        <Button isLoading>Initiating</Button>
                    ) : (
                        <Button onClick={handleInitiateActiveRecon} variant="primary" className="flex items-center gap-2">
                            <ScanLine className="h-5 w-5" />
                            Initiate Active Reconnaissance
                        </Button>
                    )}
                </div>
                {/* {scanStatus && <p className="text-sm text-gray-500">Scan Status: {scanStatus}</p>} */}
                <NoScanConfiguredTemplate
                    headerText="Active Reconnaissance Not Configured Yet"
                    descriptionText="Initiate Active Reconnaissance and View the Scan Results"
                />
            </div>
        </>
    )
}